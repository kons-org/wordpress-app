name: Build Wordpress Container
on: push
jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Get code
        uses: actions/checkout@v3
      - name: Build Image 
        run: docker build -t wordpress-app:${{github.run_number}} .
      - name: Save image tag
        run: echo "${{github.run_number}}" > image_tag.txt
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: image_tag 
          path: image_tag.txt
      - name: Push to AWS ECR
        run: |
          export AWS_ACCESS_KEY_ID=AKIAVJDXI67VVU3KRCZ3
          export AWS_SECRET_ACCESS_KEY=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
          export AWS_DEFAULT_REGION=eu-north-1
          aws ecr get-login-password --region eu-north-1 | docker login --username AWS --password-stdin 363174885355.dkr.ecr.eu-north-1.amazonaws.com
          docker tag wordpress-app:${{github.run_number}} 363174885355.dkr.ecr.eu-north-1.amazonaws.com/wordpress-app:${{github.run_number}}
          docker push 363174885355.dkr.ecr.eu-north-1.amazonaws.com/wordpress-app:${{github.run_number}}
      - name: Clean up images
        run: docker rmi -f $(docker images -q --filter "reference=*wordpress*")

      
