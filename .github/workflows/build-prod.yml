name: Build Wordpress Container Prod
on: 
  push:
    branches:
      - master
      
jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Get Code
        uses: actions/checkout@v3
      - name: Build Image 
        run: docker build -t wordpress-app:${{github.run_number}} .
      - name: Save image tag
        run: echo "${{github.run_number}}" > image_tag.txt
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with: 
          name: image_tag 
          path: image_tag.txt
      - name: Push to AWS ECR
        run: |
          export AWS_ACCESS_KEY_ID=${{secrets.AWS_ACCESS_KEY_ID}}
          export AWS_SECRET_ACCESS_KEY=${{secrets.AWS_SECRET_ACCESS_KEY}}
          export AWS_DEFAULT_REGION=${{vars.AWS_DEFAULT_REGION}}
          aws ecr get-login-password --region ${{vars.AWS_DEFAULT_REGION}} | docker login --username AWS --password-stdin ${{secrets.AWS_ACCOUNT_ID}}.dkr.ecr.${{vars.AWS_DEFAULT_REGION}}.amazonaws.com
          docker tag wordpress-app:${{github.run_number}} ${{secrets.AWS_ACCOUNT_ID}}.dkr.ecr.${{vars.AWS_DEFAULT_REGION}}.amazonaws.com/wordpress-app:${{github.run_number}}
          docker push ${{secrets.AWS_ACCOUNT_ID}}.dkr.ecr.${{vars.AWS_DEFAULT_REGION}}.amazonaws.com/wordpress-app:${{github.run_number}}
      - name: Clean up images
        run: docker rmi -f $(docker images -q --filter "reference=*wordpress*")
